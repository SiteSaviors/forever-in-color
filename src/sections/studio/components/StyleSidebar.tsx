import { Suspense, lazy } from 'react';
import { Link } from 'react-router-dom';
import { clsx } from 'clsx';
import OriginalImageCard from './OriginalImageCard';
import StyleAccordionFallback from './StyleAccordionFallback';
import './StyleSidebar.css';

const StyleAccordion = lazy(() => import('./StyleAccordion'));

type StyleSidebarProps = {
  entitlements: {
    tier: string;
    status: string;
    remainingTokens: number | null;
    quota: number | null;
  };
  hasCroppedImage: boolean;
};

const StyleSidebar = ({
  entitlements,
  hasCroppedImage,
}: StyleSidebarProps) => {
  const remainingLabel = entitlements.status === 'ready'
    ? entitlements.remainingTokens == null
      ? '∞'
      : Math.max(0, entitlements.remainingTokens)
    : '—';
  const quotaLabel = entitlements.quota == null ? '∞' : entitlements.quota;

  return (
    <aside
      className={clsx(
        'hidden lg:block lg:w-[420px] bg-slate-950/50 border-r border-white/10 lg:h-screen lg:sticky lg:top-[57px] overflow-y-auto transition-opacity duration-200',
        !hasCroppedImage && 'opacity-80 saturate-75'
      )}
    >
      <div className="style-sidebar-shell relative p-6 space-y-6">
        {!hasCroppedImage && (
          <div className="rounded-xl border border-white/12 bg-white/5 p-4 text-sm text-white/70">
            Upload your photo above to unlock style previews.
          </div>
        )}

        {/* Header */}
        <div className="relative space-y-1.5">
          <p className="text-[10px] uppercase tracking-[0.38em] text-white/50">Studio Curations</p>
          <h3 className="text-base font-display tracking-[0.16em] uppercase text-white md:text-lg">Wondertone Styles</h3>
          <p className="text-xs text-white/75 md:text-sm">Choose your artistic tone</p>
        </div>

        {/* Token Counter */}
        <div className="relative overflow-hidden rounded-2xl border border-white/10 bg-gradient-to-br from-white/10 via-transparent to-white/5 p-5 shadow-inner">
          <div
            aria-hidden="true"
            className="pointer-events-none absolute -inset-10 opacity-40 blur-2xl"
            style={{
              background:
                'radial-gradient(120% 80% at 0% 0%, rgba(79, 70, 229, 0.35), transparent 60%), radial-gradient(100% 80% at 100% 100%, rgba(14, 165, 233, 0.25), transparent 70%)',
            }}
          />
          <p className="text-xs uppercase tracking-[0.32em] text-white/60">Remaining Generations</p>
          <p className="mt-2 text-3xl font-display tracking-wider text-white">{remainingLabel}</p>
          <p className="mt-3 text-xs text-white/70">
            Tier{' '}
            <span className="font-semibold text-purple-300">
              {entitlements.tier.toUpperCase()}
            </span>{' '}
            · Quota {quotaLabel}
          </p>
          <Link
            to="/studio/usage"
            className="mt-4 inline-flex text-xs font-semibold text-purple-300 transition hover:text-purple-200"
          >
            View Usage History →
          </Link>
        </div>

        {/* ✅ NEW: Original Image always visible (not a style, just your photo) */}
        <OriginalImageCard />

        {/* ✅ Accordion with tone-based styles */}
        <Suspense fallback={<StyleAccordionFallback />}>
          <StyleAccordion hasCroppedImage={hasCroppedImage} />
        </Suspense>

        {/* Upgrade CTA */}
        <div className="p-4 rounded-xl bg-gradient-to-br from-purple-500/20 to-blue-500/20 border-2 border-purple-400/30 shadow-lg">
          <p className="text-sm font-semibold text-white mb-2">Want unlimited generations?</p>
          <p className="text-xs text-white/70 mb-3">Upgrade to Creator for unlimited style switching</p>
          <Link
            to="/pricing"
            className="block w-full px-4 py-2 rounded-lg bg-gradient-cta text-white text-sm font-bold shadow-glow-purple hover:shadow-glow-purple transition text-center"
          >
            Upgrade - $9.99/mo
          </Link>
        </div>
      </div>
    </aside>
  );
};

export default StyleSidebar;
